# 快速參考指南：Markdown vs JSON 處理

## 🎯 核心結論

### 當前問題
- **問題文件**: `agents/report_agent.py`
- **問題行**: Line 8, 170-221
- **症狀**: PDF 格式不完整，Markdown 標記沒有正確渲染

### 根本原因
```python
# ❌ 錯誤方式（當前代碼）
import markdown  # 導入但從未使用！

def _parse_markdown_to_story(self, markdown_content: str):
    lines = markdown_content.split('\n')  # 簡單分割
    for line in lines:
        if line.startswith('# '):  # 字符串匹配
            # 只能處理最基本的格式
```

## 📋 哪些應該用 JSON？

### ✅ 適合 JSON 的場景

1. **配置數據**
   ```python
   # config.json
   {
       "app_name": "東南亞金融新聞",
       "email_settings": {...}
   }
   ```

2. **結構化數據交換**（如果需要）
   ```python
   # 例如：如果要改變 Agent 之間的數據格式
   {
       "news": [
           {
               "title": "新聞標題",
               "content": "內容",
               "url": "連結"
           }
       ]
   }
   ```

3. **API 響應**
   ```python
   # Flask API 返回
   return jsonify({
       "status": "success",
       "data": {...}
   })
   ```

### ❌ 不適合 JSON 的場景

1. **AI 生成的長文本**
   - 原因：Markdown 更自然、更易讀
   - 當前正確使用：Analyst Agent 輸出 Markdown

2. **報告的最終呈現**
   - 原因：PDF 更專業
   - 當前正確使用：Report Agent 生成 PDF

## 🐍 哪些應該用 Python 處理？

### ✅ Python 應處理的 Markdown 任務

**文件**: `agents/report_agent.py`

**任務 1: Markdown → HTML**
```python
import markdown

# ✅ 正確方式
html_content = markdown.markdown(
    markdown_content,
    extensions=['extra', 'nl2br', 'sane_lists']
)
```

**任務 2: HTML → ReportLab 元素**
```python
from bs4 import BeautifulSoup

# ✅ 解析 HTML
soup = BeautifulSoup(html_content, 'html.parser')

# ✅ 轉換為 PDF 元素
for element in soup.descendants:
    if isinstance(element, NavigableString):
        continue
    
    if element.name == 'h1':
        story.append(Paragraph(element.text, styles['CustomTitle']))
    elif element.name == 'h2':
        story.append(Paragraph(element.text, styles['CustomHeading2']))
    elif element.name == 'p':
        # 處理內聯格式 (粗體、斜體、連結)
        formatted_text = self._process_inline_elements(element)
        story.append(Paragraph(formatted_text, styles['CustomBody']))
```

**任務 3: 中文字體處理**
```python
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont

# ✅ 註冊中文字體
font_paths = [
    'C:\\Windows\\Fonts\\msjh.ttc',  # 微軟正黑體
    'C:\\Windows\\Fonts\\msyh.ttc',  # 微軟雅黑
]

for font_path in font_paths:
    if Path(font_path).exists():
        pdfmetrics.registerFont(TTFont('ChineseFont', font_path))
        break
```

## 🔧 需要修改的具體位置

### 文件: `agents/report_agent.py`

#### 位置 1: 導入語句 (Line 1-19)
```python
# ✅ 添加
from bs4 import BeautifulSoup
from html.parser import HTMLParser
```

#### 位置 2: `_parse_markdown_to_story` 方法 (Line 170-221)

**替換整個方法為**:
```python
def _parse_markdown_to_story(self, markdown_content: str):
    """將 Markdown 內容轉換為 ReportLab Story（改進版）"""
    # Step 1: Markdown → HTML
    html_content = markdown.markdown(
        markdown_content,
        extensions=['extra', 'nl2br', 'sane_lists']
    )
    
    # Step 2: HTML → ReportLab 元素
    story = []
    soup = BeautifulSoup(html_content, 'html.parser')
    
    for element in soup.children:
        if element.name == 'h1':
            story.append(Paragraph(element.text, self.styles['CustomTitle']))
            story.append(Spacer(1, 0.3*inch))
        
        elif element.name == 'h2':
            story.append(Paragraph(element.text, self.styles['CustomHeading2']))
            story.append(Spacer(1, 0.2*inch))
        
        elif element.name == 'h3':
            story.append(Paragraph(element.text, self.styles['CustomHeading3']))
            story.append(Spacer(1, 0.1*inch))
        
        elif element.name == 'p':
            # 處理段落內的格式
            text = self._process_paragraph(element)
            story.append(Paragraph(text, self.styles['CustomBody']))
            story.append(Spacer(1, 0.1*inch))
        
        elif element.name == 'ul':
            # 處理無序列表
            for li in element.find_all('li'):
                text = '• ' + self._process_paragraph(li)
                story.append(Paragraph(text, self.styles['CustomBody']))
        
        elif element.name == 'hr':
            story.append(Spacer(1, 0.2*inch))
            story.append(Paragraph('_' * 80, self.styles['CustomBody']))
            story.append(Spacer(1, 0.2*inch))
    
    return story

def _process_paragraph(self, element):
    """處理段落內的內聯元素（粗體、斜體、連結）"""
    text = ""
    for child in element.children:
        if isinstance(child, str):
            text += child
        elif child.name == 'strong' or child.name == 'b':
            text += f'<b>{child.text}</b>'
        elif child.name == 'em' or child.name == 'i':
            text += f'<i>{child.text}</i>'
        elif child.name == 'a':
            href = child.get('href', '')
            text += f'{child.text} (<font color="blue">{href}</font>)'
    return text
```

## 📊 對比表

| 項目 | 當前方式 | 正確方式 | 文件位置 |
|------|---------|---------|---------|
| **Research Agent** | 返回 Markdown ✅ | 保持不變 | `agents/research_agent.py` |
| **Analyst Agent** | 輸出 Markdown ✅ | 保持不變 | `agents/analyst_agent.py` |
| **Report Agent** | 字符串匹配 ❌ | markdown 庫 ✅ | `agents/report_agent.py` |
| **數據格式** | Dict + Markdown ✅ | 保持不變 | 所有文件 |

## 🚀 實施步驟

### 第 1 步：安裝依賴
```bash
pip install beautifulsoup4
```

### 第 2 步：修改 report_agent.py
1. 添加 BeautifulSoup 導入
2. 重寫 `_parse_markdown_to_story` 方法
3. 添加 `_process_paragraph` 輔助方法

### 第 3 步：測試
```bash
python agents/report_agent.py
```

## ⚠️ 常見誤區

### 誤區 1: "應該把所有數據改成 JSON"
❌ **錯誤**: 這會失去 AI 生成自然語言的優勢  
✅ **正確**: 保持 Markdown 作為中間格式，只改進解析方式

### 誤區 2: "markdown 庫沒用，應該刪除"
❌ **錯誤**: 這個庫很有用，只是沒被正確使用  
✅ **正確**: 應該正確使用這個庫來解析 Markdown

### 誤區 3: "字符串匹配就夠了"
❌ **錯誤**: 無法處理複雜格式（粗體、斜體、連結等）  
✅ **正確**: 使用專業的 Markdown 解析器

## 💡 為什麼不全部用 JSON？

### AI Agent 生成 Markdown 的優勢
1. **自然語言**: AI 更擅長生成流暢的文字
2. **靈活性**: Markdown 可以表達豐富的格式
3. **可讀性**: 人類可以直接閱讀和編輯

### JSON 的局限性
1. **結構僵化**: 需要預定義所有字段
2. **不適合長文本**: 多段落、多格式的內容在 JSON 中難以表示
3. **AI 生成困難**: AI 可能生成格式不正確的 JSON

## 📝 總結

### 當前狀態
```
Research → Markdown → Analyst → Markdown → Report (❌ 簡單解析) → PDF
```

### 改進後
```
Research → Markdown → Analyst → Markdown → Report (✅ 正確解析) → PDF
                                              ↓
                                         markdown 庫
                                              ↓
                                         BeautifulSoup
                                              ↓
                                         ReportLab
```

### 關鍵點
- **保持**: Research 和 Analyst 使用 Markdown ✅
- **修改**: Report Agent 正確解析 Markdown ✅
- **避免**: 不需要改成全 JSON 流程 ❌

---

**參考文檔**:
- `MARKDOWN_PDF_分析報告.md` - 完整分析
- `架構分析圖.txt` - 視覺化架構圖
- `agents/report_agent.py` - 需要修改的文件
